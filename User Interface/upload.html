<!DOCTYPE html>
<html lang="en">
<head> 
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Upload Skin Photo</title> 
  <link rel="stylesheet" href="style.css"> 
  <style>
    /* Fade-in animation for page elements */
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #a1c4fd, #c2e9fb); /* Sky Blue Gradient */
      background-attachment: fixed;
      margin: 0;
      padding: 0;
      text-align: center;
      animation: fadeIn 1.5s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h2 {
      margin-top: 50px;
      color: #004e92;
      font-size: 1.8rem;
      animation: fadeIn 2s ease-in-out;
    }

    /* Glowing main buttons */
    .btn {
      display: block;
      width: 250px;
      max-width: 90%;
      margin: 15px auto;
      padding: 12px 20px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      cursor: pointer;
      background: #ffffff;
      color: #007acc;
      font-weight: bold;
      box-shadow: 0 0 15px rgba(0, 191, 255, 0.3), 0 0 25px rgba(0, 191, 255, 0.2);
      transition: all 0.3s ease-in-out;
      animation: fadeIn 2s ease-in-out;
    }

    .btn:hover {
      transform: scale(1.08);
      background: #e6f7ff;
      box-shadow: 0 0 25px rgba(0, 191, 255, 0.6), 0 0 40px rgba(0, 191, 255, 0.4);
    }

    /* Webcam video preview with fade-in */
    #webcam {
      margin-top: 20px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 191, 255, 0.3);
      opacity: 0;
      transition: opacity 1s ease-in-out;
    }

    #webcam.visible {
      opacity: 1;
    }

    /* Navigation / Back button */
    .navigation {
      margin-top: 30px;
    }

    .navigation a.back-btn {
      display: inline-block;
      width: auto;
      text-decoration: none;
      padding: 10px 20px;
      border-radius: 30px;
      font-weight: bold;
      background: linear-gradient(135deg, #007bff, #00bfff);
      color: #fff;
      box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
      transition: all 0.3s ease;
    }

    .navigation a.back-btn:hover {
      transform: scale(1.05);
      background: linear-gradient(135deg, #00bfff, #007bff);
      box-shadow: 0 6px 15px rgba(0, 123, 255, 0.4);
    }

    footer {
      margin-top: 30px;
      text-align: center;
      color: #00bfff;
      font-size: 14px;
      padding: 15px 0;
      border-top: 1px solid #00bfff;
      animation: fadeIn 2.5s ease-in-out;
    }

    /* Hidden class for elements */
    .hidden {
      display: none;
    }

    #webcam-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.85);
  z-index: 2000;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
}

#webcam-overlay video {
  width: 90%;
  max-width: 800px;
  height: auto;
  border-radius: 15px;
  border: 4px solid #00bfff;
}

#countdown {
  position: absolute;
  font-size: 8rem;
  color: white;
  font-weight: bold;
  text-shadow: 0 0 20px rgba(0,0,0,0.7);
}

/* This keeps the overlay hidden by default */
#webcam-overlay.hidden {
  display: none;
}
.floating-back-btn {
  position: fixed; /* This is the key property */
  top: 20px;
  left: 20px;
  z-index: 1000;
  display: inline-block;
  margin-top: 20px;
  padding: 10px 25px;
  background: linear-gradient(135deg, #007bff, #00bfff);
  color: white;
  text-decoration: none;
  border-radius: 30px;
  font-weight: bold;
  box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
  transition: all 0.3s ease;
}

.floating-back-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(0, 123, 255, 0.4);
}
/* In uploads.html, add this to your <style> tag */

#loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.75); /* Semi-transparent black */
  z-index: 3000; /* Highest z-index to be on top of everything */
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: white;
  transition: opacity 0.3s ease;
}

#loading-overlay.hidden {
  /* Instead of display:none, we use opacity for a smooth fade-out */
  opacity: 0;
  pointer-events: none;
}

/* The spinning circle */
.spinner {
  width: 60px;
  height: 60px;
  border: 5px solid #ffffff40; /* Light gray border */
  border-top: 5px solid #00bfff; /* Blue top border */
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

.loading-text {
  font-size: 1.2rem;
  font-weight: bold;
}

/* The keyframe animation for the spinner */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
  </style>
</head> 
<body> 
 <!-- Hidden input for file selection (Gallery/Camera) -->
    <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFileSelect(event)">
    
    <!-- Hidden Canvas for Webcam snapshot -->
    <canvas id="snapshot-canvas" class="hidden"></canvas>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        Scanning your glow, bestie‚Ä¶ üîÆ‚ú®
    </div>
   <div class="page center"> 
     <h2>Choose how you wanna glow, cutie ‚ú®</h2> 
    
    <button class="btn" onclick="openCamera()" id="photo-btn">üì∏ Lemme take a photo</button>
    
    <button class="btn" onclick="openGallery()" id="gallery-btn">üñº I‚Äôll pick from my gallery</button>
    
    <button class="btn" onclick="startAutomaticScan()" id="webcam-stream-btn">üíª Use Webcam for Auto-Scan</button>

    <div id="webcam-overlay" class="hidden">
      <video id="webcam" autoplay muted playsinline></video>
      <div id="countdown"></div>
    </div>
    
  </div> 
  <div id="loading-overlay" class="hidden">
    <div class="spinner"></div>
    <p class="loading-text">Analyzing your glow...</p>
  </div>
  <a href="#" onclick="history.back(); return false;" class="floating-back-btn">‚Üê Back</a>
  <script> 
    

document.addEventListener('DOMContentLoaded', () => {
    const userId = localStorage.getItem("userId");
    if (!userId) return; // If no user is logged in, do nothing

    // --- 1. Fetch User Profile Data ---
    fetch(`${API_BASE_URL}/user/${userId}`)
        .then(res => res.json())
        .then(data => {
            if (data.user) {
                const user = data.user;
                // Update the corner profile icon
                document.getElementById("profileAvatar").innerText = user.username.charAt(0).toUpperCase();
                
                // Update the profile card
                document.getElementById("name").innerText = user.username;
                document.getElementById("email").innerText = user.email;
                document.getElementById("phone").innerText = user.phone || "N/A";
            }
        })
        .catch(err => console.error("Error fetching profile:", err));

    // --- 2. Fetch User Scan History ---
    fetch(`${API_BASE_URL}/user/history/${userId}`)
        .then(res => res.json())
        .then(data => {
            const historyDiv = document.getElementById("history");
            historyDiv.innerHTML = ""; // Clear "Loading..." text

            if (!data.history || data.history.length === 0) {
                historyDiv.innerHTML = "<p>No scan history yet.</p>";
                return;
            }

            data.history.forEach(scan => {
                const item = document.createElement("div");
                item.classList.add("history-item");
                item.innerHTML = `
                    <p><strong>Type:</strong> ${scan.skin_type} (${scan.confidence}%)</p>
                    <p><small>${scan.timestamp}</small></p>
                `;
                historyDiv.appendChild(item);
            });
        })
        .catch(err => console.error("Error fetching history:", err));
});
function toggleProfilePanel() {
    const panel = document.querySelector('.profile-container');
    panel.classList.toggle('visible');
}

    // --- Function for the "Take a photo" button ---
function openCamera() {
    const fileInput = document.getElementById('file-input');
    // This attribute tells mobile browsers to open the camera directly
    fileInput.setAttribute('capture', 'user');
    fileInput.click();
}

// --- Function for the "Pick from gallery" button ---
function openGallery() {
    const fileInput = document.getElementById('file-input');
    // We remove the capture attribute to ensure the file picker opens
    fileInput.removeAttribute('capture');
    fileInput.click();
}
    
    const BACKEND_URL = 'http://127.0.0.1:5000/api';
    let videoStream = null;

function startAutomaticScan() {
    const overlay = document.getElementById('webcam-overlay');
    const video = document.getElementById('webcam');
    const countdownDiv = document.getElementById('countdown');

    overlay.classList.remove('hidden');

    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            videoStream = stream;
            video.srcObject = stream;
            
            // Start a 3-second countdown
            let count = 3;
            countdownDiv.textContent = count;
            
            const countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownDiv.textContent = count;
                } else {
                    countdownDiv.textContent = 'üì∏'; // Show a camera emoji on capture
                    clearInterval(countdownInterval);
                    
                    // After 1 more second, take the snapshot
                    setTimeout(takeSnapshot, 1000);
                }
            }, 1000);
        })
        .catch(err => {
            alert('Webcam not accessible! Please check permissions.');
            overlay.classList.add('hidden');
            console.error('Webcam error:', err);
        });
}

// In uploads.html, replace your existing takeSnapshot function with this

// In uploads.html, replace your existing takeSnapshot function with this new one

function takeSnapshot() {
    const overlay = document.getElementById('webcam-overlay');
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('snapshot-canvas');
    const countdownDiv = document.getElementById('countdown');

    if (!videoStream) return;

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');

    // Un-mirror the image
    ctx.translate(canvas.width, 0);
    ctx.scale(-1, 1);
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    ctx.setTransform(1, 0, 0, 1, 0, 0); // Reset transform

    // Stop the webcam stream
    videoStream.getTracks().forEach(track => track.stop());
    videoStream = null;

    // --- NEW: PREVIEW AND CONFIRMATION STEP ---
    canvas.toBlob(blob => {
        if (!blob) {
            alert('Failed to capture snapshot.');
            return;
        }

        // Create a temporary URL for the captured image
        const imageUrl = URL.createObjectURL(blob);
        
        // Open the image in a new tab for you to inspect
        window.open(imageUrl, '_blank');

        // Ask for confirmation before sending to the model
        const userConfirmation = confirm(
            "A preview of your snapshot has been opened in a new tab.\n\n" +
            "Does the image look clear and well-lit?\n\n" +
            "Click 'OK' to send it for analysis, or 'Cancel' to try again."
        );

        // Hide the overlay regardless of choice
        overlay.classList.add('hidden');
        countdownDiv.textContent = '';

        if (userConfirmation) {
            // If user clicks OK, send the image to the backend
            uploadImage(blob);
        } else {
            // If user clicks Cancel, do nothing
            alert("Scan cancelled. Please try again with better lighting.");
        }

    }, 'image/jpeg', 0.9);
}
    // --- File/Gallery Handler ---
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            // Uploads the selected file directly
            uploadImage(file);
        }
    }
    
    // --- Snapshot and Upload (for Webcam) ---
    function takeSnapshotAndUpload() {
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('snapshot-canvas');
        
        if (!videoStream) {
            alert("Webcam is not active. Please start the stream first.");
            return;
        }

        // Set canvas dimensions to match video frame
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        // Draw the current video frame onto the canvas
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Convert canvas content to a Blob (image file data)
        canvas.toBlob(function(blob) {
            if (blob) {
                stopWebcam(); // Stop stream immediately after capture
                uploadImage(blob);
            } else {
                alert('Failed to capture snapshot.');
            }
        }, 'image/jpeg', 0.9); // 0.9 is quality setting
    }

    // --- Core API Upload Function ---
    async function uploadImage(imageBlob) {
        const userId = localStorage.getItem('userId');
        
        if (!userId) {
            alert('Please log in first to scan your photo.');
            window.location.href = 'login.html'; 
            return;
        }

        document.getElementById('loading-overlay').classList.remove('hidden');
        
        const formData = new FormData();
        formData.append('user_id', userId);
        formData.append('image', imageBlob, 'scan.jpg'); 

        try {
            const response = await fetch(`${BACKEND_URL}/predict`, {
                method: 'POST',
                body: formData // Fetch handles Content-Type boundary for FormData
            });

            const result = await response.json();
            
            if (response.ok && result.status === 'success') {
                // Save the prediction results to session storage before redirecting
                sessionStorage.setItem('skin_type', result.skin_type);
                sessionStorage.setItem('confidence', result.confidence);
                sessionStorage.setItem('detailed_scores', JSON.stringify(result.detailed_scores));
                sessionStorage.setItem('scan_status', 'success');
                 // Redirect to results page
                window.location.href = 'results.html';
            } else {
                alert(`Prediction failed: ${result.message || 'Server Error'}`);
            }
        } catch (error) {
            alert('Network error during prediction. Is your Flask server running?');
            console.error('Upload error:', error);
        } finally {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
    }

    // --- Save scan result to backend DB ---
    async function saveScanResult(userId, skinType, confidence) {
        try {
            const response = await fetch(`${BACKEND_URL}/scan/save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: userId,
                    skin_type: skinType,
                    confidence: confidence
                })
            });
            const result = await response.json();
            if (!response.ok) console.warn('Failed to save scan:', result.message);
        } catch (err) {
            console.error('Error saving scan:', err);
        }
    }

    // --- Stop Webcam Function ---
    function stopWebcam() {
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
    }

    // Clean up webcam when leaving page
    window.addEventListener("beforeunload", stopWebcam);
  </script>

  <footer>
    <p>This website is created by <strong>Bhanu Oleti</strong> ‚ú®üíô</p>
    <p>
      Wanna match my vibe? üíå 
      <a href="mailto:bhanuoleti66@gmail.com" style="color: #00bfff; text-decoration: none;">
        bhanuoleti66@gmail.com
      </a>
    </p>
  </footer>
</body>
</html>