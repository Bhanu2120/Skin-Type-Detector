<!DOCTYPE html>
<html lang="en">
<head> 
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Upload Skin Photo</title> 
  
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    html, body { 
      overflow: hidden;
      height: 100%;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
      background-attachment: fixed;
      margin: 0; padding: 0;
      text-align: center;
      animation: fadeIn 1.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    h2 {
      margin-top: 50px;
      color: #004e92;
      font-size: 1.8rem;
    }
    .btn {
      display: block; width: 250px; max-width: 90%;
      margin: 15px auto; padding: 12px 20px;
      border: none; border-radius: 12px;
      font-size: 1rem; cursor: pointer;
      background: #ffffff; color: #007acc;
      font-weight: bold;
      box-shadow: 0 0 15px rgba(0, 191, 255, 0.3), 0 0 25px rgba(0, 191, 255, 0.2);
      transition: all 0.3s ease-in-out;
    }
    .btn:hover {
      transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(0, 123, 255, 0.4);
    }
    .hidden { display: none; }
    

    .back-btn {
      position: fixed; 
  top: 20px;
  left: 20px;
  z-index: 1000;
  display: inline-block;
  padding: 10px 25px;
  background: linear-gradient(135deg, #007bff, #00bfff);
  color: white;
  text-decoration: none;
  border-radius: 30px;
  font-weight: bold;
  box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
  transition: all 0.3s ease;
    }
    .back-btn:hover { transform: scale(1.1); }

  
    .profile-avatar {
      position: fixed; top: 20px; right: 20px; width: 50px; height: 50px;
      border-radius: 50%; background: #2563eb; color: white; font-weight: bold;
      display: flex; justify-content: center; align-items: center;
      font-size: 22px; cursor: pointer; box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      transition: transform 0.3s; z-index: 1000;
    }
    .profile-avatar:hover { transform: scale(1.1); }

    #webcam-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.85); z-index: 2000;
      display: flex; justify-content: center; align-items: center; flex-direction: column;
    }
    #webcam-overlay.hidden { display: none; }
    #webcam-overlay video { width: 90%; max-width: 800px; height: auto; border-radius: 15px; border: 4px solid #00bfff; }
    #countdown { position: absolute; font-size: 8rem; color: white; font-weight: bold; text-shadow: 0 0 20px rgba(0,0,0,0.7); }
    .instructions { position: absolute; bottom: 30px; background-color: rgba(0, 0, 0, 0.6); color: white; padding: 10px 20px; border-radius: 10px; font-size: 1rem; text-align: center; }


    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.75); z-index: 3000;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      color: white; opacity: 1; transition: opacity 0.3s ease;
    }
    #loading-overlay.hidden { opacity: 0; pointer-events: none; }
    .spinner {
      width: 60px; height: 60px; border: 5px solid #ffffff40;
      border-top: 5px solid #00bfff; border-radius: 50%;
      animation: spin 1s linear infinite; margin-bottom: 20px;
    }
    .loading-text { font-size: 1.2rem; font-weight: bold; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    footer {
      position: fixed; bottom: 0; width: 100%;
      color: #007acc; font-size: 14px;
      padding: 15px 0;
    }
    @media (max-width: 768px) {
  h2 {
   
    font-size: 1.6rem;
    margin-top: 80px; 
  }

  .back-btn {
    padding: 8px 20px;  
    font-size: 0.9rem;    
    top: 15px;           
    left:15px;
  }
  footer {  
    font-size: 12px;
  }
  body {
  overflow: auto;
}
back-btn:hover, .back-btn:active {
    transform: scale(1.05); /* Use a smaller scale effect for mobile */
  }
}

@keyframes slideUpFadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.page-center > h2, .page-center > .btn {
  opacity: 0; 
  animation: slideUpFadeIn 0.6s ease-out forwards;
}

.page-center > h2 { 
  animation-delay: 0.2s; 
}
.page-center > .btn:nth-of-type(1) { 
  animation-delay: 0.4s; 
}
.page-center > .btn:nth-of-type(2) { 
  animation-delay: 0.6s; 
}
.page-center > .btn:nth-of-type(3) { 
  animation-delay: 0.8s; 
}
@keyframes slideUpFadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

 </style>
</head> 
<body> 

  <a href="precautions.html" class="back-btn">← Back</a>
  <div id="profileAvatar" class="profile-avatar" onclick="window.location.href='profile.html'">U</div>
  
  <div id="loading-overlay" class="hidden">
    <div class="spinner"></div>
    <p class="loading-text">Analyzing your glow...</p>
  </div>

  <div class="page-center"> 
    <h2>Choose how you wanna glow, cutie ✨</h2> 
    <button class="btn" onclick="openCamera()" id="photo-btn">📸 Lemme take a photo</button>
    <button class="btn" onclick="openGallery()" id="gallery-btn">🖼 I’ll pick from my gallery</button>
    <button class="btn" onclick="startAutomaticScan()" id="webcam-stream-btn">💻 Use Webcam for Auto-Scan</button>
  </div> 

  <input type="file" id="file-input" accept="image/*" capture="user" class="hidden" onchange="handleFileSelect(event)">
  <canvas id="snapshot-canvas" class="hidden"></canvas>
  <div id="webcam-overlay" class="hidden">
    <video id="webcam" autoplay muted playsinline></video>
    <div id="countdown"></div>
    <div class="instructions">💡 Position your face in the frame and hold still.</div>
  </div>
  <footer> 
    <p>This website is created by <strong>Bhanu Oleti</strong> ✨💙</p> 
    <p>Wanna match my vibe? 💌 <a href="mailto:bhanuoleti66@gmail.com" style="color: #007acc; text-decoration: none;">bhanuoleti66@gmail.com</a></p> 
  </footer> 

<script>
    const API_BASE_URL = '/api';

    let videoStream = null;

    document.addEventListener('DOMContentLoaded', () => {
        const userId = localStorage.getItem("userId");
        if (userId) {
            fetch(`${API_BASE_URL}/user/${userId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.user && data.user.username) {
                        document.getElementById("profileAvatar").innerText = data.user.username.charAt(0).toUpperCase();
                    }
                })
                .catch(err => console.error("Error fetching profile for avatar:", err));
        }
    });

    function openCamera() {
        const fileInput = document.getElementById('file-input');
        fileInput.setAttribute('capture', 'user');
        fileInput.click();
    }

    function openGallery() {
        const fileInput = document.getElementById('file-input');
        fileInput.removeAttribute('capture');
        fileInput.click();
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            uploadImage(file);
        }
    }

    function startAutomaticScan() {
        const overlay = document.getElementById('webcam-overlay');
        const video = document.getElementById('webcam');
        const countdownDiv = document.getElementById('countdown');
        overlay.classList.remove('hidden');

        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                videoStream = stream;
                video.srcObject = stream;
                let count = 3;
                countdownDiv.textContent = count;
                const countdownInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdownDiv.textContent = count;
                    } else {
                        countdownDiv.textContent = '📸';
                        clearInterval(countdownInterval);
                        setTimeout(takeSnapshot, 1000);
                    }
                }, 1000);
            })
            .catch(err => {
                Swal.fire({ icon: 'error', title: 'Webcam Error', text: 'Webcam access was denied. Please allow camera access in your browser settings.', color: '#00558A'});
                overlay.classList.add('hidden');
            });
    }

    function takeSnapshot() {
        const overlay = document.getElementById('webcam-overlay');
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('snapshot-canvas');
        const countdownDiv = document.getElementById('countdown');

        if (!videoStream) return;

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');

        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        ctx.setTransform(1, 0, 0, 1, 0, 0);

        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;

        canvas.toBlob(blob => {
            if (!blob) {
                Swal.fire({ icon: 'error', title: 'Snapshot Failed', text: 'Could not capture an image from the webcam.', color: '#00558A'});
                return;
            }
            overlay.classList.add('hidden');
            countdownDiv.textContent = '';
            uploadImage(blob);
        }, 'image/jpeg', 0.9);
    }

    async function uploadImage(imageBlob) {
        const userId = localStorage.getItem('userId');
        
        if (!userId) {
            Swal.fire({ icon: 'warning', title: 'Not Logged In', text: 'Please log in first to scan your photo.', color: '#00558A'})
                .then(() => { window.location.href = 'login.html'; });
            return;
        }

        document.getElementById('loading-overlay').classList.remove('hidden');
        
        const formData = new FormData();
        formData.append('user_id', userId);
        formData.append('image', imageBlob, 'scan.jpg');

        try {
            const response = await fetch(`${API_BASE_URL}/predict`, {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            
            if (response.ok && result.status === 'success') {
                sessionStorage.setItem('skin_type', result.skin_type);
                sessionStorage.setItem('confidence', result.confidence);
                sessionStorage.setItem('detailed_scores', JSON.stringify(result.detailed_scores));
                sessionStorage.setItem('scan_status', 'success');
                window.location.href = 'results.html';
            } else {
                // BUG FIX: Hide the loading screen on error
                document.getElementById('loading-overlay').classList.add('hidden');
                Swal.fire({ icon: 'error', title: 'Scan Failed', text: result.message || 'An unknown error occurred.', color: '#00558A' });
            }
        } catch (error) {
            // BUG FIX: Hide the loading screen on error
            document.getElementById('loading-overlay').classList.add('hidden');
            Swal.fire({ icon: 'error', title: 'Network Error', text: 'Could not connect to the server. Is it running?', color: '#00558A' });
            console.error('Upload error:', error);
        }
    }
</script> 
</body> 
</html>